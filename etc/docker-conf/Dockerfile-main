FROM pombase/web-base:v15
ARG version

LABEL maintainer="Kim Rutherford <kim@pombase.org>"

ARG target
ENV ANALYTICS_ID=UNSET
ENV APP_DEPLOY_CONFIG="{ mode: 'prod' }"

WORKDIR /pombase

RUN mkdir bin; mkdir -p /var/www/html/api/v1/dataset/latest/
RUN ln -s /pombase/jbrowse /var/www/html/jbrowse

COPY pombase-chado-json /pombase/pombase-chado-json
ENV PATH="/root/.cargo/bin/:${PATH}"
RUN curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain nightly; \
  rustup default nightly; \
  (cd pombase-chado-json; cargo build --release && cp target/release/pombase-server /pombase/bin/); \
  rm -r /root/.rustup /pombase/pombase-chado-json

COPY web-json /var/www/html/web-json
COPY gff /pombase/gff
COPY chromosome_fasta /pombase/chromosome_fasta

COPY website_config/pombase_v2_config.json /pombase/pombase_v2_config.json
RUN (cd /var/www/html/api/v1/dataset/latest; ln -s /var/www/html/web-json data)

RUN cd ./solr-7.1.0/; ./bin/solr start -force -m 10g; \
    ./bin/solr create_core -force -c terms; \
    curl http://localhost:8983/solr/terms/config -d '{"set-user-property": {"update.autoCreateFields":"false"}}'; \
    curl -X POST -H 'Content-type:application/json' --data-binary '{"add-field-type":{"name":"idField","class":"solr.StrField"}}' http://localhost:8983/solr/terms/schema; \
    curl -X POST -H 'Content-type:application/json' --data-binary '{"add-field-type":{"name":"textField","class":"solr.TextField","analyzer":{"type":"index","tokenizer":{"class":"solr.LowerCaseTokenizerFactory"},"filter":{"class":"solr.EdgeNGramFilterFactory","minGramSize":"2", "maxGramSize":"50"}}, "analyzer":{"type":"query", "tokenizer":{"class":"solr.LowerCaseTokenizerFactory"}}}}' http://localhost:8983/solr/terms/schema; \
    curl -X POST -H 'Content-type:application/json' --data-binary '{"add-field":{"name":"cv_name","type":"idField","indexed":"true","stored":"true"}}' http://localhost:8983/solr/terms/schema; \
    curl -X POST -H 'Content-type:application/json' --data-binary '{"add-field":{"name":"name","type": "textField","indexed":"true","stored":"true"}}' http://localhost:8983/solr/terms/schema; \
    curl -X POST -H 'Content-type:application/json' --data-binary '{"add-field":{"name":"close_synonyms","type":"textField","multiValued":"true","indexed":"true","stored":"true"}}' http://localhost:8983/solr/terms/schema; \
    curl -X POST -H 'Content-type:application/json' --data-binary '{"add-field":{"name":"distant_synonyms","type": "textField","multiValued":"true","indexed":"true","stored":"true"}}' http://localhost:8983/solr/terms/schema; \
    curl -X POST -H 'Content-type:application/json' --data-binary '{"add-field":{"name":"interesting_parents","type": "textField","multiValued":"true","indexed":"true","stored":"true"}}' http://localhost:8983/solr/terms/schema; \
    curl -X POST -H 'Content-type:application/json' --data-binary '{"add-field":{"name":"definition","type":"textField","indexed":"true","stored":"true"}}' http://localhost:8983/solr/terms/schema; \
    gzip -d < /var/www/html/api/v1/dataset/latest/data/solr_data/terms.json.gz | ./bin/post -c terms -type application/json -d && \
    ./bin/solr stop && \
    rm -rf /var/www/html/api/v1/dataset/latest/data/solr_data

COPY ng-website /pombase/ng-website
RUN (cd ng-website/frontend; ln -fs /pombase/pombase_v2_config.json .; \
     cp etc/update_vars.sh /pombase/ && \
     npm install; \
     ./etc/build_app.sh $target && cp -r dist/* /var/www/html/) && \
     rm -rf /pombase/ng-website /usr/lib/node_modules

COPY trackList.json /pombase/jbrowse/data/trackList.json
COPY pombase_jbrowse_track_metadata.csv /pombase/jbrowse/data/pombase_jbrowse_track_metadata.csv

RUN (cd /var/www/html/jbrowse; \
    ./bin/prepare-refseqs.pl --fasta /pombase/chromosome_fasta/Schizosaccharomyces_pombe_all_chromosomes.fa.gz; \
    ./bin/flatfile-to-json.pl --gff /pombase/gff/all_chromosomes_forward_strand.gff3 \
      --maxLookback 9999999 --trackType CanvasFeatures --trackLabel 'PomBase forward strand features'; \
    ./bin/flatfile-to-json.pl --gff /pombase/gff/all_chromosomes_reverse_strand.gff3 \
      --maxLookback 9999999 --trackType CanvasFeatures --trackLabel 'PomBase reverse strand features')

COPY conf/circus.ini circus.ini
COPY conf/start_all.sh start_all.sh
RUN (cd /var/www/html/jbrowse; ./bin/generate-names.pl)

RUN echo $version > $HOME/pombase_version

# for testing:
EXPOSE 8983
EXPOSE 8500

HEALTHCHECK --start-period=10s --interval=10s --timeout=20s --retries=10 \
  CMD curl -f http://localhost:8500/ && curl -f http://localhost:8983/ || exit 1

CMD ./start_all.sh

