FROM pombase/web-base:v23
ARG version

LABEL maintainer="Kim Rutherford <kim@pombase.org>"

ARG target
ENV ANALYTICS_ID=UNSET
ENV APP_DEPLOY_CONFIG="{ mode: 'prod' }"

USER pombase

WORKDIR /pombase

COPY --chown=pombase:pombase pombase-chado-json /pombase/pombase-chado-json
ENV PATH="/pombase/.cargo/bin/:${PATH}"
RUN mkdir bin
RUN curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain nightly && \
  rustup default nightly && \
  (cd pombase-chado-json; cargo build --release && cp target/release/pombase-server /pombase/bin/) && \
  rm -r /pombase/.rustup /pombase/pombase-chado-json

USER root

RUN mkdir -p /var/www/html/api/v1/dataset/latest/; ln -s /pombase/jbrowse /var/www/html/jbrowse

COPY --chown=pombase:pombase web-json /var/www/html/web-json
COPY --chown=pombase:pombase gff /pombase/gff
COPY --chown=pombase:pombase chromosome_fasta /pombase/chromosome_fasta

COPY --chown=pombase:pombase website_config/pombase_v2_config.json /pombase/pombase_v2_config.json
RUN (cd /var/www/html/api/v1/dataset/latest; ln -s /var/www/html/web-json data)
RUN chown -R pombase:pombase /var/www/html

COPY --chown=pombase:pombase conf/solr-schema-commands.txt /pombase/solr-schema-commands.txt

USER pombase

RUN cd ./solr-7.1.0/; ./bin/solr start -force -m 10g; \
    ./bin/solr create_core -force -c terms; \
    curl http://localhost:8983/solr/terms/config -d '{"set-user-property": {"update.autoCreateFields":"false"}}'; \
    while read command; do curl -X POST -H 'Content-type:application/json' -d "$command" http://localhost:8983/solr/terms/schema; done < /pombase/solr-schema-commands.txt; \
    gzip -d < /var/www/html/api/v1/dataset/latest/data/solr_data/terms.json.gz | ./bin/post -c terms -type application/json -d && \
    ./bin/solr stop && \
    rm -rf /var/www/html/api/v1/dataset/latest/data/solr_data

COPY --chown=pombase:pombase ng-website /pombase/ng-website
RUN mkdir /pombase/.npm-global; npm config set prefix "/pombase/.npm-global"

ENV PATH="/pombase/.npm-global/bin:$PATH"

RUN (cd ng-website/frontend; ln -fs /pombase/pombase_v2_config.json .; \
     cp etc/update_vars.sh /pombase/ && \
     npm install -g yarn; \
     yarn; \
     ./etc/build_app.sh $target && cp -r dist/* /var/www/html/) && \
     rm -rf /pombase/ng-website /pombe/.npm-global

COPY --chown=pombase:pombase trackList.json /pombase/jbrowse/data/trackList.json
COPY --chown=pombase:pombase pombase_jbrowse_track_metadata.csv /pombase/jbrowse/data/pombase_jbrowse_track_metadata.csv

RUN (cd /var/www/html/jbrowse; \
    ./bin/prepare-refseqs.pl --fasta /pombase/chromosome_fasta/Schizosaccharomyces_pombe_all_chromosomes.fa.gz \
      --trackLabel 'DNA sequence' --key 'DNA sequence'; \
    ./bin/flatfile-to-json.pl --gff /pombase/gff/all_chromosomes_forward_strand.gff3 \
      --maxLookback 9999999 --trackType CanvasFeatures --trackLabel 'PomBase forward strand features'; \
    ./bin/flatfile-to-json.pl --gff /pombase/gff/all_chromosomes_reverse_strand.gff3 \
      --maxLookback 9999999 --trackType CanvasFeatures --trackLabel 'PomBase reverse strand features')

COPY --chown=pombase:pombase conf/circus.ini circus.ini
COPY --chown=pombase:pombase conf/start_all.sh start_all.sh
RUN (cd /var/www/html/jbrowse; ./bin/generate-names.pl)

RUN echo $version > $HOME/pombase_version

# for testing:
EXPOSE 8983
EXPOSE 8500

HEALTHCHECK --start-period=10s --interval=10s --timeout=20s --retries=10 \
  CMD curl -f http://localhost:8500/ && curl -f http://localhost:8983/ || exit 1

CMD ./start_all.sh

